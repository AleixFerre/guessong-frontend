<div class="page">
  <app-home-hero
    [lobby]="lobby()"
    [pingMs]="ws.pingMs()"
    [volume]="volume()"
    (volumeChange)="updateVolume($event)"
    (leave)="confirmLeaveLobby()"
  ></app-home-hero>

  <section
    class="grid"
    [class.grid--menu]="viewState() === 'MENU'"
    [class.grid--waiting]="viewState() === 'WAITING'"
    [class.grid--waiting-host]="viewState() === 'WAITING' && isHost()"
    [class.grid--waiting-guest]="viewState() === 'WAITING' && !isHost()"
    [class.grid--playing]="viewState() === 'IN_GAME' || viewState() === 'FINISHED'"
  >
    @if (viewState() === 'MENU') {
      <div class="panel panel--menu">
        <div class="menu-layout">
          <div class="menu-actions-block">
            @if (entryMode(); as selectedEntry) {
              <div class="menu-heading">
                <button
                  class="icon-button icon-button--back"
                  (click)="resetEntryMode()"
                  aria-label="Volver"
                >
                  <span class="icon-button__glow" aria-hidden="true"></span>
                  <svg viewBox="0 0 24 24" role="presentation" aria-hidden="true">
                    <path
                      d="M15.5 5.5l-6 6 6 6"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2.4"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                    <path
                      d="M9.5 11.5h9"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2.4"
                      stroke-linecap="round"
                    ></path>
                  </svg>
                </button>
                <h2>{{ selectedEntry === 'create' ? 'Crear sala' : 'Unirse a sala' }}</h2>
              </div>
              <app-lobby-setup
                [entryMode]="selectedEntry"
                [libraries]="libraries()"
                [selectedLibraryInfo]="selectedLibraryInfo()"
                [lobbyName]="lobbyName"
                [joinLobbyId]="joinLobbyId"
                [library]="library"
                [roundDuration]="roundDuration"
                [penalty]="penalty"
                [maxPlayers]="maxPlayers"
                [totalRounds]="totalRoundsInput"
                [maxGuessesPerRound]="maxGuessesPerRound"
                [guessOptionsLimit]="guessOptionsLimit"
                [requireBuzzToGuess]="requireBuzzToGuess"
                [lockoutSeconds]="lockoutSeconds"
                [responseSeconds]="responseSeconds"
                [isPublicLobby]="isPublicLobby"
                [publicLobbies]="publicLobbies()"
                [publicLobbiesLoading]="publicLobbiesLoading()"
                [showPublicLobbies]="showPublicLobbies()"
                (createLobbyRequest)="createLobby()"
                (joinLobbyRequest)="joinLobby()"
                (togglePublicLobbiesRequest)="togglePublicLobbies()"
                (refreshPublicLobbiesRequest)="loadPublicLobbies()"
                (joinPublicLobbyRequest)="joinPublicLobby($event)"
              ></app-lobby-setup>
            } @else {
              <h2 class="title">Menu principal</h2>
              <p class="menu-description">
                Crea una sala nueva o entra a una existente. Aqui empieza la partida.
              </p>
              <div class="menu-actions menu-actions--cards">
                <button class="menu-card primary" (click)="selectEntryMode('create')">
                  <span class="menu-card__icon menu-card__icon--create" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <path
                        d="M5 13.5l4.2 4.2L19 8.5"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      ></path>
                    </svg>
                  </span>
                  <span class="menu-card__text">
                    <span class="menu-card__title">Crear sala</span>
                    <span class="menu-card__subtitle">Invita y personaliza tu partida.</span>
                  </span>
                </button>
                <button class="menu-card secondary" (click)="selectEntryMode('join')">
                  <span class="menu-card__icon menu-card__icon--join" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="presentation">
                      <path
                        d="M4 12h10"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                      ></path>
                      <path
                        d="M11 7l5 5-5 5"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      ></path>
                    </svg>
                  </span>
                  <span class="menu-card__text">
                    <span class="menu-card__title">Unirse a sala</span>
                    <span class="menu-card__subtitle">Pega el codigo y entra rapido.</span>
                  </span>
                </button>
              </div>
            }
          </div>

          <div class="menu-identity">
            <div class="menu-identity__head">
              <h3>Tu identidad</h3>
              <p class="muted">Elige un nombre y un avatar para la sala.</p>
            </div>
            <div class="field">
              <label class="label-with-tip">
                Nombre de usuario
                <span class="tooltip">
                  ?
                  <span class="tooltip-text">
                    Nombre que veran los demas jugadores en la sala.
                  </span>
                </span>
              </label>
              <div class="name-input">
                <input
                  type="text"
                  [value]="username()"
                  (input)="username.set($any($event.target).value)"
                  [class.name-input--reveal]="randomNameRevealed()"
                  (animationend)="finishRandomNameReveal()"
                  placeholder="Tu nombre"
                />
                <button
                  type="button"
                  class="name-random"
                  [class.name-random--rolling]="randomNameRolling()"
                  (click)="randomizeUsername()"
                  aria-label="Generar nombre aleatorio"
                >
                  <img
                    src="/icons/dice.svg"
                    alt=""
                    aria-hidden="true"
                    (animationend)="finishRandomNameRoll()"
                  />
                </button>
              </div>
            </div>
            <div class="avatar-picker">
              @for (avatar of avatarOptions; track avatar) {
                <button
                  type="button"
                  class="avatar-option"
                  [class.active]="selectedAvatar() === avatar"
                  (click)="selectedAvatar.set(avatar)"
                  [style.backgroundImage]="'url(avatars/' + avatar + ')'"
                  aria-label="Seleccionar avatar"
                ></button>
              }
              <button
                type="button"
                class="avatar-option avatar-option--random"
                (click)="selectRandomAvatar()"
                aria-label="Seleccionar avatar aleatorio"
              >
                <img src="/icons/dice.svg" alt="" aria-hidden="true" />
              </button>
            </div>
            <p class="avatar-credit">{{ avatarCredit }}</p>
          </div>
        </div>
      </div>
    }
    @if (viewState() === 'WAITING') {
      <div class="panel panel--lobby">
        <app-lobby-panel
          [lobby]="lobby()"
          [isHost]="isHost()"
          [currentPlayerId]="playerId()"
          [activeBuzzPlayerId]="activeBuzzPlayerId()"
          [maxGuessesPerRound]="maxGuessesPerRound()"
          [guessCounts]="guessCounts()"
          [showScore]="false"
          [showLockout]="false"
          [showTries]="false"
          [showRanks]="false"
          [showCopyLink]="true"
          (startGameRequest)="startGame()"
          (copyLinkRequest)="copyLobbyLink()"
        ></app-lobby-panel>
      </div>
      <div class="panel panel--config">
        @if (isHost()) {
          <div class="panel-header">
            <h2 class="title">Configurar sala</h2>
          </div>
          <app-lobby-setup
            entryMode="edit"
            [libraries]="libraries()"
            [selectedLibraryInfo]="selectedLibraryInfo()"
            [lobbyName]="lobbyName"
            [joinLobbyId]="joinLobbyId"
            [library]="library"
            [roundDuration]="roundDuration"
            [penalty]="penalty"
            [maxPlayers]="maxPlayers"
            [totalRounds]="totalRoundsInput"
            [maxGuessesPerRound]="maxGuessesPerRound"
            [guessOptionsLimit]="guessOptionsLimit"
            [requireBuzzToGuess]="requireBuzzToGuess"
            [lockoutSeconds]="lockoutSeconds"
            [responseSeconds]="responseSeconds"
            [isPublicLobby]="isPublicLobby"
            [publicLobbies]="publicLobbies()"
            [publicLobbiesLoading]="publicLobbiesLoading()"
            [showPublicLobbies]="showPublicLobbies()"
            [canSave]="canSaveLobbySettings()"
            (updateLobbyRequest)="updateLobbySettings()"
            (togglePublicLobbiesRequest)="togglePublicLobbies()"
            (refreshPublicLobbiesRequest)="loadPublicLobbies()"
            (joinPublicLobbyRequest)="joinPublicLobby($event)"
          ></app-lobby-setup>
        } @else {
          <div class="panel-header">
            <h2 class="title">Información de la sala</h2>
          </div>
          <div class="config-readonly">
            <div class="config-item">
              <span>Biblioteca</span>
              <strong>{{ selectedLibraryInfo()?.name ?? lobby()?.settings?.library }}</strong>
            </div>
            <div class="config-item">
              <span>Max. jugadores</span>
              <strong>{{ maxPlayers() }}</strong>
            </div>
            <div class="config-item">
              <span>Requiere PULSA</span>
              <strong>{{ requireBuzzToGuess() ? 'Si' : 'No' }}</strong>
            </div>
            <div class="config-item">
              <span>Rondas</span>
              <strong>{{ totalRoundsInput() }}</strong>
            </div>
            <div class="config-item">
              <span>Duración de ronda</span>
              <strong>{{ roundDuration() }}s</strong>
            </div>
            <div class="config-item">
              <span>Intentos por ronda</span>
              <strong>{{ maxGuessesPerRound() === 0 ? 'Infinito' : maxGuessesPerRound() }}</strong>
            </div>
            <div class="config-item">
              <span>Opciones por ronda</span>
              <strong>{{ guessOptionsLimit() }}</strong>
            </div>
            <div class="config-item">
              <span>Tiempo de bloqueo</span>
              <strong>{{ lockoutSeconds() === 0 ? 'Sin bloqueo' : lockoutSeconds() + 's' }}</strong>
            </div>
            <div class="config-item">
              <span>Tiempo para responder</span>
              <strong>{{
                responseSeconds() === 0 ? 'Sin limite' : responseSeconds() + 's'
              }}</strong>
            </div>
            <div class="config-item">
              <span>Penalización por fallo</span>
              <strong>{{ penalty() }}%</strong>
            </div>
          </div>
        }
      </div>
    }
    @if (viewState() === 'IN_GAME' || viewState() === 'FINISHED') {
      <div class="panel panel--lobby">
        <app-lobby-panel
          [lobby]="lobby()"
          [isHost]="isHost()"
          [playersOverride]="sortedPlayers()"
          [showActions]="false"
          [currentPlayerId]="playerId()"
          [activeBuzzPlayerId]="activeBuzzPlayerId()"
          [maxGuessesPerRound]="maxGuessesPerRound()"
          [guessCounts]="guessCounts()"
        ></app-lobby-panel>
      </div>

      <div class="panel panel--game">
        <app-game-panel
          [progressPercent]="progressPercent()"
          [roundDurationSec]="roundDurationSec()"
          [elapsedSeconds]="elapsedSeconds()"
          [roundStatus]="roundStatus()"
          [currentRound]="currentRound()"
          [totalRounds]="totalRoundsDisplay()"
          [canBuzz]="canBuzz()"
          [canGuess]="canGuess()"
          [remainingGuesses]="remainingGuesses()"
          [maxGuessesPerRound]="maxGuessesPerRound()"
          [guessTracks]="roundGuessTracks()"
          [winnerName]="roundWinnerName()"
          [buzzCountdownSec]="buzzCountdownSec()"
          [buzzOwnerName]="activeBuzzPlayerName()"
          [isBuzzOwner]="activeBuzzPlayerId() === playerId()"
          [requireBuzzToGuess]="requireBuzzToGuess()"
          [roundResult]="roundResult()"
          [isWinner]="isRoundWinner()"
          [notifications]="notifications()"
          [audioUnavailable]="audioUnavailable()"
          (buzzRequest)="sendBuzz()"
          (guessRequest)="sendGuess($event)"
        ></app-game-panel>
      </div>
    }
  </section>

  @if (roundResult(); as result) {
    @if (showResultModal()) {
      <div class="result-modal">
        <div
          class="result-card"
          [class.result--win]="isRoundWinner()"
          [class.result--lose]="!isRoundWinner()"
        >
          <h3>Resultado</h3>
          <p>{{ result.revealedTrackMeta.artist }} - {{ result.revealedTrackMeta.title }}</p>
          @if (roundWinnerName()) {
            <div class="winner-row">
              @if (roundWinnerPlayer(); as winner) {
                <span
                  class="winner-avatar"
                  [style.backgroundImage]="
                    winner.avatar ? 'url(avatars/' + winner.avatar + ')' : null
                  "
                  aria-hidden="true"
                ></span>
              }
              <p>Ganador: {{ roundWinnerName() }}</p>
            </div>
          } @else {
            <p class="no-winner">No ha habido ganador</p>
          }
          @if (result.winnerId) {
            <p>Puntos: {{ result.pointsAwarded }}</p>
          }
          @if (nextRoundCountdownSec() !== null) {
            <div class="next-round">
              <p>
                @if (viewState() === 'FINISHED') {
                  Resultados finales en {{ formatCountdown(nextRoundCountdownSec() ?? 0) }}
                } @else {
                  Siguiente ronda en {{ formatCountdown(nextRoundCountdownSec() ?? 0) }}
                }
              </p>
              <div class="countdown-bar" aria-hidden="true">
                <span class="countdown-fill" [style.width.%]="nextRoundProgress() ?? 0"></span>
              </div>
            </div>
          }
        </div>
      </div>
    }
  }

  @if (viewState() === 'FINISHED' && showFinalOverlay()) {
    <div class="end-overlay">
      <div class="panel end-card">
        <h2>Clasificación final</h2>
        <div class="end-players">
          @for (player of sortedPlayers(); track player.id) {
            <div class="end-player">
              <span
                class="end-avatar"
                [style.backgroundImage]="
                  player.avatar ? 'url(avatars/' + player.avatar + ')' : null
                "
                aria-hidden="true"
              ></span>
              <span
                class="end-rank"
                [class.end-rank--leader]="$index === 0"
                [class.end-rank--silver]="$index === 1"
                [class.end-rank--bronze]="$index === 2"
              >
                #{{ $index + 1 }}
              </span>
              <span class="end-name">{{ player.username }}</span>
              <strong class="end-score">{{ player.score }}</strong>
            </div>
          }
        </div>
        <button class="primary" (click)="requestRematch()" [disabled]="rematchRequested()">
          {{ rematchRequested() ? 'Revancha aceptada' : 'Revancha' }}
        </button>
        <p class="muted">
          {{ rematchRequested() ? 'La revancha empezará' : 'La sala se disolverá' }} automáticamente
          en {{ dissolveCountdownDisplay() }}s.
        </p>
        <div class="countdown-bar end-countdown" aria-hidden="true">
          <span class="countdown-fill" [style.width.%]="dissolveProgress()"></span>
        </div>
      </div>
    </div>
  }
</div>
