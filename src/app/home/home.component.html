<div class="page">
  <app-home-hero
    [lobby]="lobby()"
    [pingMs]="ws.pingMs()"
    (leave)="confirmLeaveLobby()"
  ></app-home-hero>

  <div class="volume-float">
    <div class="volume-header">
      <label for="volume-slider">Volumen</label>
      <span class="volume-value">{{ volume() }}%</span>
    </div>
    <input
      id="volume-slider"
      type="range"
      min="0"
      max="100"
      [value]="volume()"
      (input)="updateVolume(+$any($event.target).value)"
    />
  </div>

  <section
    class="grid"
    [class.grid--menu]="viewState() === 'MENU'"
    [class.grid--waiting]="viewState() === 'WAITING'"
    [class.grid--waiting-host]="viewState() === 'WAITING' && isHost()"
    [class.grid--waiting-guest]="viewState() === 'WAITING' && !isHost()"
    [class.grid--playing]="viewState() === 'IN_GAME' || viewState() === 'FINISHED'"
  >
    @if (viewState() === 'MENU') {
      <div class="panel panel--menu">
        @if (entryMode(); as selectedEntry) {
          <div class="menu-heading">
            <button class="icon-button" (click)="resetEntryMode()" aria-label="Volver">←</button>
            <h2>{{ selectedEntry === 'create' ? 'Crear sala' : 'Unirse a sala' }}</h2>
          </div>
          <app-lobby-setup
            [entryMode]="selectedEntry"
            [libraries]="libraries()"
            [selectedLibraryInfo]="selectedLibraryInfo()"
            [username]="username"
            [joinLobbyId]="joinLobbyId"
            [library]="library"
            [roundDuration]="roundDuration"
            [penalty]="penalty"
            [maxPlayers]="maxPlayers"
            [totalRounds]="totalRoundsInput"
            [maxGuessesPerRound]="maxGuessesPerRound"
            [lockoutSeconds]="lockoutSeconds"
            [responseSeconds]="responseSeconds"
            [createPassword]="createPassword"
            [joinPassword]="joinPassword"
            (createLobbyRequest)="createLobby()"
            (joinLobbyRequest)="joinLobby()"
          ></app-lobby-setup>
        } @else {
          <h2 class="title">Menu principal</h2>
          <p class="menu-description">
            Elige si quieres crear una sala nueva o unirte a una partida existente.
          </p>
          <div class="menu-actions">
            <button class="primary" (click)="selectEntryMode('create')">Crear sala</button>
            <button class="secondary" (click)="selectEntryMode('join')">Unirse a sala</button>
          </div>
        }
      </div>
    }
    @if (viewState() === 'WAITING') {
      <div class="panel panel--lobby">
        <app-lobby-panel
          [lobby]="lobby()"
          [isHost]="isHost()"
          [currentPlayerId]="playerId()"
          [activeBuzzPlayerId]="activeBuzzPlayerId()"
          [maxGuessesPerRound]="maxGuessesPerRound()"
          [guessCounts]="guessCounts()"
          [showScore]="false"
          [showLockout]="false"
          [showTries]="false"
          [showRanks]="false"
          (startGameRequest)="startGame()"
        ></app-lobby-panel>
      </div>
      <div class="panel panel--config">
        @if (isHost()) {
          <div class="panel-header">
            <h2>Configurar sala</h2>
            <button class="ghost copy-link" (click)="copyLobbyLink()">Copiar link</button>
          </div>
          <app-lobby-setup
            entryMode="edit"
            [libraries]="libraries()"
            [selectedLibraryInfo]="selectedLibraryInfo()"
            [username]="username"
            [joinLobbyId]="joinLobbyId"
            [library]="library"
            [roundDuration]="roundDuration"
            [penalty]="penalty"
            [maxPlayers]="maxPlayers"
            [totalRounds]="totalRoundsInput"
            [maxGuessesPerRound]="maxGuessesPerRound"
            [lockoutSeconds]="lockoutSeconds"
            [responseSeconds]="responseSeconds"
            [createPassword]="createPassword"
            [joinPassword]="joinPassword"
            (updateLobbyRequest)="updateLobbySettings()"
          ></app-lobby-setup>
        } @else {
          <div class="panel-header">
            <h2>Información de la sala</h2>
            <button class="ghost copy-link" (click)="copyLobbyLink()">Copiar link</button>
          </div>
          <div class="config-readonly">
            <div class="config-item">
              <span>Biblioteca</span>
              <strong>{{ selectedLibraryInfo()?.name ?? lobby()?.settings?.library }}</strong>
            </div>
            <div class="config-item">
              <span>Duración de ronda</span>
              <strong>{{ roundDuration() }}s</strong>
            </div>
            <div class="config-item">
              <span>Max. jugadores</span>
              <strong>{{ maxPlayers() }}</strong>
            </div>
            <div class="config-item">
              <span>Rondas</span>
              <strong>{{ totalRoundsInput() }}</strong>
            </div>
            <div class="config-item">
              <span>Intentos por ronda</span>
              <strong>{{ maxGuessesPerRound() === 0 ? 'Infinito' : maxGuessesPerRound() }}</strong>
            </div>
            <div class="config-item">
              <span>Tiempo de bloqueo</span>
              <strong>{{ lockoutSeconds() === 0 ? 'Sin bloqueo' : lockoutSeconds() + 's' }}</strong>
            </div>
            <div class="config-item">
              <span>Tiempo para responder</span>
              <strong>{{
                responseSeconds() === 0 ? 'Sin limite' : responseSeconds() + 's'
              }}</strong>
            </div>
            <div class="config-item">
              <span>Penalización por fallo</span>
              <strong>{{ penalty() }}%</strong>
            </div>
          </div>
        }
      </div>
    }
    @if (viewState() === 'IN_GAME' || viewState() === 'FINISHED') {
      <div class="panel panel--lobby">
        <app-lobby-panel
          [lobby]="lobby()"
          [isHost]="isHost()"
          [playersOverride]="sortedPlayers()"
          [showActions]="false"
          [currentPlayerId]="playerId()"
          [activeBuzzPlayerId]="activeBuzzPlayerId()"
          [maxGuessesPerRound]="maxGuessesPerRound()"
          [guessCounts]="guessCounts()"
        ></app-lobby-panel>
      </div>

      <div class="panel panel--game">
        <app-game-panel
          [progressPercent]="progressPercent()"
          [roundDurationSec]="roundDurationSec()"
          [elapsedSeconds]="elapsedSeconds()"
          [roundStatus]="roundStatus()"
          [currentRound]="currentRound()"
          [totalRounds]="totalRoundsDisplay()"
          [canBuzz]="canBuzz()"
          [canGuess]="canGuess()"
          [remainingGuesses]="remainingGuesses()"
          [maxGuessesPerRound]="maxGuessesPerRound()"
          [guessTracks]="roundGuessTracks()"
          [winnerName]="roundWinnerName()"
          [buzzCountdownSec]="buzzCountdownSec()"
          [buzzOwnerName]="activeBuzzPlayerName()"
          [isBuzzOwner]="activeBuzzPlayerId() === playerId()"
          [roundResult]="roundResult()"
          [isWinner]="isRoundWinner()"
          [notifications]="notifications()"
          [audioUnavailable]="audioUnavailable()"
          (buzzRequest)="sendBuzz()"
          (guessRequest)="sendGuess($event)"
        ></app-game-panel>
      </div>
    }
  </section>

  @if (roundResult(); as result) {
    @if (viewState() !== 'FINISHED') {
      <div class="result-modal">
        <div
          class="result-card"
          [class.result--win]="isRoundWinner()"
          [class.result--lose]="!isRoundWinner()"
        >
          <h3>Resultado</h3>
          <p>{{ result.revealedTrackMeta.artist }} - {{ result.revealedTrackMeta.title }}</p>
          @if (roundWinnerName()) {
            <p>Ganador: {{ roundWinnerName() }}</p>
          } @else {
            <p class="no-winner">No ha habido ganador</p>
          }
          @if (result.winnerId) {
            <p>Puntos: {{ result.pointsAwarded }}</p>
          }
          @if (nextRoundCountdownSec() !== null) {
            <p class="next-round">
              Siguiente ronda en {{ formatCountdown(nextRoundCountdownSec() ?? 0) }}
            </p>
          }
        </div>
      </div>
    }
  }

  @if (viewState() === 'FINISHED' && showFinalOverlay()) {
    <div class="end-overlay">
      <div class="panel end-card">
        <h2>Clasificación final</h2>
        <div class="end-players">
          @for (player of sortedPlayers(); track player.id) {
            <div class="end-player">
              <span
                class="end-rank"
                [class.end-rank--leader]="$index === 0"
                [class.end-rank--silver]="$index === 1"
                [class.end-rank--bronze]="$index === 2"
              >
                #{{ $index + 1 }}
              </span>
              <span class="end-name">{{ player.username }}</span>
              <strong class="end-score">{{ player.score }}</strong>
            </div>
          }
        </div>
        <button class="primary" (click)="requestRematch()" [disabled]="rematchRequested()">
          {{ rematchRequested() ? 'Revancha aceptada' : 'Revancha' }}
        </button>
        <p class="muted">
          {{ rematchRequested() ? 'La revancha empezará' : 'La sala se disolverá' }} automáticamente
          en {{ dissolveCountdown() }}s.
        </p>
      </div>
    </div>
  }
</div>
