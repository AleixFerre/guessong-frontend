<div class="game-header">
  <h2>En juego</h2>
  @if (totalRounds()) {
    <span class="round-pill">Ronda {{ currentRound() }}/{{ totalRounds() }}</span>
  }
</div>
<div class="game">
  <div class="progress">
    <div class="bar" [style.width.%]="progressPercent()"></div>
  </div>
  <div class="timer">
    <span>{{ formatTime(roundDurationSec() - elapsedSeconds()) }}</span>
    <small>{{ formatRoundStatus(roundStatus()) }}</small>
  </div>
  @if (audioUnavailable()) {
    <div class="audio-warning">No hay audio disponible para esta ronda.</div>
  }
  <div class="controls">
    <button class="buzz" [disabled]="!canBuzz()" (click)="buzzRequest.emit()">PULSA</button>
  </div>
  @if (roundStatus() === 'PAUSED' && buzzCountdownSec() !== null) {
    <div class="buzz-timer">
      @if (isBuzzOwner()) {
        <span>Tiempo para responder: {{ formatTime(buzzCountdownSec() ?? 0) }}</span>
      } @else {
        <span>
          {{ buzzOwnerName() ?? 'Jugador' }} ha pulsado: {{ formatTime(buzzCountdownSec() ?? 0) }}
        </span>
      }
    </div>
  }
  <div class="guess">
    <app-guess-input
      [tracks]="guessTracks()"
      [value]="guessText()"
      (valueChange)="guessText.set($event)"
      [placeholder]="guessTracks().length ? 'Escribe tu respuesta' : 'Cargando canciones...'"
      [disabled]="!canGuess()"
      [autoFocus]="canGuess()"
    />
    <button
      class="primary"
      [disabled]="!canGuess() || !isGuessAllowed() || !hasGuessesLeft()"
      (click)="sendGuess()"
    >
      Enviar
    </button>
  </div>
  @if (roundResult(); as result) {
    <div class="result">
      <h3>Resultado</h3>
      <p>{{ result.revealedTrackMeta.title }} â€” {{ result.revealedTrackMeta.artist }}</p>
      @if (result.winnerId) {
        <p>Puntos: {{ result.pointsAwarded }}</p>
      }
    </div>
  }
</div>
@defer (when notifications().length) {
  <div class="notifications">
    @for (note of notifications(); track $index) {
      <div class="note">{{ note }}</div>
    }
  </div>
} @placeholder {
} @loading {
} @error {}
